{% extends 'plantilla/base.html' %}
{% block main %}
<main id="main" class="main">
  
  <div class="pagetitle">
    <h1>Compras</h1>
    <nav>
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="index.html">Home</a></li>
        <li class="breadcrumb-item active">Compras</li>
      </ol>
    </nav>
  </div><!-- End Page Title -->
  
  <section class="section dashboard">
    <div class="row">
      <div class="col-lg-12"> 
          <div class="card">
              <div class="card-body">
                  <h5 class="card-title">Compras</h5> 
                  <a type="submit" id="btnEditar" class="btn btn-success" href="{% url 'agregarCompras' %}">
                  Agregar compra
                  </a> 
                  <a type="submit" id="btnEditar" class="btn btn-primary" href="{% url 'export_compras_to_excel' %}">
                    Exportar todo los datos a excel 
                  </a> 
                   
                  <h3><strong>Buscar entre fechas: </strong></h3>
                  <div class="d-flex align-items-center">
                    <div class="me-2">
                      <input type="date" id="fechaInicio" class="form-control">
                    </div>
                    <div class="me-2">
                      <input type="date" id="fechaFin" class="form-control">
                    </div>
                    <button class="btn btn-dark" id="filtrar">Filtrar</button>
                  </div>
                  

                  <!-- Table with stripped rows -->
                  <table class="table datatable">
                      <thead>
                          <tr>
                              <th scope="col">#</th>
                              <th scope="col">Documento</th>
                              <th scope="col">Proveedor</th>
                              <th scope="col">Total</th>
                              <th scope="col">Fecha</th>
                              <th scope="col">Acciones</th>
                          </tr>
                      </thead>
                      <tbody>
                            {% for resultado in resultados %}
                              
                              <tr class="registro">
                                <td>{{ forloop.counter }}</td>
                                <td>{{ resultado.numcorrelativo }}</td>
                                <td>{{ resultado.idproveedor__razonsocial }}</td>
                                <td> {{ resultado.total }} </td>
                                <td class="fechaCompra">{{  resultado.fechacompra}}</td>
                                <td>
                                  <a type="submit" href="{% url 'editarCompras' id=resultado.idcompra %}" class="btn " >
                                    
                                     <i class="fa-solid fa-pen-to-square fa-2xl" style="color: #005eff;">
                                     </i>
                                  </a>
                                  
                                  <a href="{% url 'eliminarCompras' id=resultado.idcompra%}" class="eliminar" onclick="return confirmarEliminar('{{ resultado.idcompra }}', this)">
                                    <i class="fa-solid fa-trash fa-2xl" style="color: #f71b02;"></i>
                                  </a>

                                </td> 
                              </tr>
                            {% endfor %}
                         
                        
                      </tbody>
                  </table>
                  <!-- End Table with stripped rows -->
                  
              </div>
          </div>
          
      </div>
    </div>
  </section>
  
</main><!-- End #main -->

<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
 <script>
    
    function confirmarEliminar0(idCompra, enlace) {
      let urlEliminar = $(enlace).attr("href");
      Swal.fire({
        title: '¿Seguro que quieres eliminar esta compra?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Sí, eliminar',
        cancelButtonText: 'Cancelar'
      }).then((result) => {
        if (result.isConfirmed) {

          // Redirige a la URL para eliminar la compra si el usuario confirma
          $.ajax({
            type: "GET",
            url: urlEliminar,
            data: {csrfmiddlewaretoken: '{{ csrf_token }}'}, // Incluye el token CSRF en la solicitud
            success: function(response) {
              console.log(response); // Maneja la respuesta si es necesario
              window.location.href='compras'
            },

          });

        }
      });
      return false; // Detiene la acción predeterminada del enlace
    
    }

    
    
  //Buscar entre fechas
  $(function() {

    $('#filtrar').click(function(){

      $.ajax({
          type: "POST",
          url: "{% url 'buscarFecha' %}",
          data: {
              fechaInicio: $('#fechaInicio').val(),
              fechaFin: $('#fechaFin').val(),
              csrfmiddlewaretoken: '{{ csrf_token }}' 
          },
          success: function (response) {
              console.log(response);
              $('tbody').empty(); // Vacía el contenido de la tabla antes de agregar los nuevos resultados
  
              $.each(response, function(index, resultado) {
                  var row = $('<tr>').addClass('registro');
                  row.append($('<td>').text(index + 1)); // Agrega el número de fila
                  row.append($('<td>').text(resultado.numcorrelativo));
                  row.append($('<td>').text(resultado['idproveedor__razonsocial']));
                  row.append($('<td>').text(resultado.total));
  
                  // Ajusta la fecha para mostrarla en la zona horaria local del navegador
                  var fechaCompra = new Date(resultado.fechacompra + 'T00:00:00Z'); // Ajusta a UTC
                  fechaCompra = new Date(fechaCompra.getTime() + fechaCompra.getTimezoneOffset() * 60000); // Ajusta a la zona horaria local
                  var options = { day: 'numeric', month: 'long', year: 'numeric' };
                  var fechaFormateada = fechaCompra.toLocaleDateString('es-PE', options); // Usar 'es-PE' para Perú
                  
                  row.append($('<td>').addClass('fechaCompra').text(fechaFormateada));
  
                  // Crea el botón de editar
                  var editButton = $('<a>').addClass('btn');
                  editButton.attr('href', '/compras/editar/' + resultado.idcompra);
                  editButton.append($('<i>').addClass('fa-solid fa-pen-to-square fa-2xl').css('color', '#005eff'));
                  
                  // Crea el botón de eliminar
                  var deleteButton = $('<a>').attr('href', '/compras/eliminar/' + resultado.idcompra).addClass('eliminar').click(function(){
                      return confirmarEliminar(resultado.idcompra, this);
                  });
                  deleteButton.append($('<i>').addClass('fa-solid fa-trash fa-2xl').css('color', '#f71b02'));
       
                  // Crea la columna de acciones y agrega los botones
                  var actionColumn = $('<td>').append(editButton).append(deleteButton);
  
                  // Agrega la columna de acciones a la fila
                  row.append(actionColumn);
  
                  // Agrega la fila a la tabla
                  $('tbody').append(row);
              });
              
          }
      });
  
  });
  

  })



</script>
  
  
  
  {% endblock %}






