{% extends 'plantilla/base.html' %}
{% block main %}
<main id="main" class="main">
  <div class="pagetitle">
    <h1>Categorias</h1>
    <nav>
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="index.html">Home</a></li>
        <li class="breadcrumb-item active">Categorias</li>
      </ol>
    </nav>
  </div><!-- End Page Title -->

  <section class="section dashboard">
    <div class="row">
      <div class="col-lg-12">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">Categorias</h5>
            <button type="" class="btn btn-success"  data-bs-toggle="modal"
              data-bs-target="#myModaAgregar">Agregar categoría</button>
              
              <table class="table datatable">
                <thead>
                  <tr>
                    <th scope="col">CODIGO</th>
                    <th scope="col">Categoria</th>
                    <th scope="col">Acciones</th>
                  </tr>
                </thead>
                <tbody>
                  {% for categorias_registro in cateogiras_registros %}
                  <tr>
                    <td>{{ forloop.counter }}</td>
                    <td>{{ categorias_registro.nomcategoria }}</td>
                    <td>
                      <a type="button" id="btnEditar" class="btn" data-bs-toggle="modal" data-bs-target="#myModal2{{ categorias_registro.idcategoria }}">
                        <i class="fa-solid fa-pen-to-square fa-2xl" style="color: #005eff;"></i>
                      </a>
                      <a href="{% url 'categoriasEliminar' id=categorias_registro.idcategoria %}" class="eliminar"
                        onclick="return confirmarEliminar('{{ categorias_registro.idcategoria }}', this)">
                        <i class="fa-solid fa-trash fa-2xl" style="color: #f71b02;"></i>
                      </a>
                    </td>
                     <!-- Modales de editar -->
                     <div class="modal fade" id="myModal2{{ categorias_registro.idcategoria }}" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
                      <div class="modal-dialog" role="document">
                        <div class="modal-content">
                          <div class="modal-header">
                            <h4 class="modal-title">Editar categoria</h4>
                            <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                              <span aria-hidden="true">&times;</span>
                            </button>
                          </div>
                          <div class="modal-body">
                            <form id="formEditarCategoria{{ categorias_registro.idcategoria }}" action="{% url 'editarCategorias' %}" method="post" enctype="multipart/form-data">
                              {% csrf_token %}
                              <div class="form-group">
                                <label for="nombreProducto2"><strong>Nombre</strong></label>
                                <input type="text" name="nameCategoria" value="{{ categorias_registro.nomcategoria }}" class="form-control">
                                <input type="hidden" name="idCategoria" value="{{ categorias_registro.idcategoria }}">
                              </div>
                              <div class="modal-footer">
                                <button type="button" class="btn btn-secondary btn-editar" data-id="{{ categorias_registro.idcategoria }}">Guardar</button>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                              </div>
                            </form>
                          </div>
                        </div>
                      </div>
                    </div>
                      <!-- fin del modal editar -->
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
              
             
              


            <!-- Modal de Agregar -->
            <div class="modal" id="myModaAgregar">
              <div class="modal-dialog">
                <div class="modal-content">

                  <!-- Cabecera del modal -->
                  <div class="modal-header">
                    <h4 class="modal-title">Editar categoria</h4>
                    <button type="button" class="close" data-bs-dismiss="modal">&times;</button>
                  </div>

                  <!-- Contenido del modal De editar-->
                  <div class="modal-body">

                    <!-- inicio de form -->

                    <form id="formAgregarCategoria" action="{% url 'agregarCategorias' %}" method="post" enctype="multipart/form-data">
                      {% csrf_token %}
                      <label for="nombreProducto2">Nombre</label><br>
                      <input type="text" name="nameCategoriaAgregar" class="form-control">
                      
                      <div style="display:flex; margin-left:140px;">
                          <div class="modal-footer">
                              <button type="button" class="btn btn-secondary" id="agregar">Agregar</button>
                          </div>
                          <div class="modal-footer">
                              <button type="button" id="btn-cerrar" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                          </div>
                      </div>
                    </form>
                  

                  <!-- fin del form -->

                </div>

                <!-- Pie del modal -->

              </div>
            </div>

            <!-- Fin del modal agregar-->

          </div>
        </div>

      </div>
    </div>
  </section>

</main><!-- End #main -->

<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script>
$(function(){
  //Para agregar
    $("#agregar").click(function(){
        // Obtener los datos del formulario
        var formData = new FormData($('#formAgregarCategoria')[0]);
        
        // Realizar la solicitud AJAX
        $.ajax({
            type: "POST",
            url: "{% url 'agregarCategorias' %}",
            data: formData,
            processData: false,  // Evitar que jQuery procese los datos automáticamente
            contentType: false,  // No establecer automáticamente el tipo de contenido
            success: function (response) {
                Swal.fire({
                    title: 'Categoría guardada exitosamente',
                    icon: 'success',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: '¡Ok!',
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Redireccionar solo si el usuario hace clic en "OK"
                        window.location.href=  "{% url 'categorias' %}";
                    }
                });
            },
            error: function(response) {
                Swal.fire({
                    title: 'Error al guardar la categoría',
                    text: response.responseText,
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
            }
        });

        return false; // Prevenir el envío del formulario por defecto
    });

    //Para editar
    $(".btn-editar").click(function(){
        var id = $(this).data('id');
        var form = $('#formEditarCategoria' + id);
        var formData = new FormData(form[0]);

        $.ajax({
            type: "POST",
            url: form.attr('action'),
            data: formData,
            processData: false,  // Evitar que jQuery procese los datos automáticamente
            contentType: false,  // No establecer automáticamente el tipo de contenido
            success: function (response) {
                Swal.fire({
                    title: 'Categoría editada exitosamente',
                    icon: 'success',
                    confirmButtonColor: '#3085d6',
                    confirmButtonText: '¡Ok!',
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Redireccionar solo si el usuario hace clic en "OK"
                        window.location.href = "{% url 'categorias' %}";
                    }
                });
            },
            error: function(response) {
                Swal.fire({
                    title: 'Error al guardar la categoría',
                    text: response.responseText,
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
            }
        });

        return false; // Prevenir el envío del formulario por defecto
    });
});



  function confirmarEliminar(idCompra, enlace) {
    let urlEliminar = $(enlace).attr("href");
    Swal.fire({
      title: '¿Seguro que quieres eliminar esta compra?',
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#3085d6',
      cancelButtonColor: '#d33',
      confirmButtonText: 'Sí, eliminar',
      cancelButtonText: 'Cancelar'
    }).then((result) => {
      if (result.isConfirmed) {

        // Redirige a la URL para eliminar la compra si el usuario confirma
        $.ajax({
          type: "GET",
          url: urlEliminar,
          data: { csrfmiddlewaretoken: '{{ csrf_token }}' }, // Incluye el token CSRF en la solicitud
          success: function (response) {
            console.log(response); // Maneja la respuesta si es necesario
            window.location.href = 'categorias'
          },

        });

      }
    });
    return false; // Detiene la acción predeterminada del enlace
  }


</script>
{% endblock %}