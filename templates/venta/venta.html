{% extends 'plantilla/base.html' %}
{% block main %}

<div id="contenido">



<main id="main" class="main">

<div class="pagetitle">
<h1>Ventas</h1>
<nav>
<ol class="breadcrumb">
  <li class="breadcrumb-item"><a href="index.html">Home</a></li>
  <li class="breadcrumb-item active">Ventas</li>
</ol>
</nav>
</div><!-- End Page Title -->

<section class="section dashboard">
<div class="row">
    <div class="col-lg-12"> 
    <div class="card">
        <div class="card-body">
            <h5 class="card-title">VENTAS</h5>
            <a type="submit" id="btnEditar" class="btn btn-success" href="{% url 'agregarVenta' %}">
            Nueva venta
            </a> 
            <a type="submit" id="btnExportarExcel" class="btn btn-primary" href="{% url 'export_to_excel_ventas' %}">
              Exportar todo los datos a excel 
            </a>
            <h3><strong>Buscar entre fechas: </strong></h3>
            <div class="d-flex align-items-center">
              <div class="me-2">
                <input type="date" id="fechaInicio" class="form-control">
              </div>
              <div class="me-2">
                <input type="date" id="fechaFin" class="form-control">
              </div>
              <button class="btn btn-dark" id="filtrar">Filtrar</button>
            </div>
            <table class="table datatable">
                <thead>
                    <tr>
                        <th scope="col">Venta</th>
                        <th scope="col">Cliente</th>
                        <th scope="col">Total</th>
                        <th scope="col">Fecha</th>
                        <th scope="col">Doc</th>
                        <th scope="col">Ticket</th>
                        <th scope="col">A4</th>
                        <th scope="col">CDR</th>
                        <!-- <th scope="col">Ticket</th> -->
                        <th scope="col">Editar</th>
                        <th scope="col">Sunat</th>
                        
                    </tr>
                </thead>
                <tbody>
                
                    {% for resultado in resultados %}
                        
                    
                        <tr>

                            <td>{{ forloop.counter }}</td>
                            <td>{{ resultado.1 }}</td> <!-- Accediendo al segundo elemento de la tupla para razonsocial -->
                            <td>{{ resultado.2|floatformat:2 }}</td><!-- Accediendo al tercer elemento de la tupla para total -->
                            <td>{{ resultado.3}}</td> <!-- Accediendo al cuarto elemento de la tupla para fechaemision -->
                            <td>{{ resultado.4 }}-{{ resultado.5 }}</td>

                            <!-- Ticket -->
                            <td>
                              {% if resultado.10 %}
                                <a  href="{{ resultado.10 }}" target="_blank">
                                  <i class="fa-solid fa-ticket fa-2xl" style="color: #005eff; margin-left: 30px;"></i>
                                </a>
                              {% else %}
                                  Falta envíar
                              {% endif %}
                            </td>
                            <!-- PDF -->
                            <td>
                              {% if resultado.6 %}
                                <a  href="{{ resultado.6 }}" target="_blank">
                                  <i class="fa-solid fa-file-pdf fa-2xl" style="color: #005eff; margin-left: 30px;"></i>
                                </a>
                              {% else %}
                                Falta envíar
                              {% endif %}
                            </td>
                     
                                     
                            <td>
                              {% if resultado.6 %}
                                <a  href="{{ resultado.7 }}" target="_blank">
                                  <i class="fa-regular fa-file fa-2xl" style="color: #005eff; margin-left: 30px;"></i>
          
                                </a>
                              {% else %}
                                Falta envíar
                              {% endif %}
                            </td>

                            <td>
                              {% if not resultado.6 %}
                                <a type="submit"  href="{% url 'editarVenta' id=resultado.0 %}">
                                    <i class="fa-solid fa-pen-to-square fa-2xl" style="color: #005eff;"></i>
                                </a>

                                <a href="{% url 'eliminarVentas' id=resultado.0 %}" class="eliminar" onclick="return confirmarEliminar('{{ resultado.0 }}', this)">
                                    <i class="fa-solid fa-trash fa-2xl" style="color: #f71b02;"></i>
                                  </a>
                                {% else %}
                                <i class="fa-solid fa-check fa-2xl" style="color: #005eff; margin-left: 30px;"></i>
                                {% endif %}
                            </td>
  
                            <td class="iconSunat"> 
                                {% if resultado.6 %}
                                <i class="fa-solid fa-check fa-2xl" style="color: #005eff; margin-left: 30px;"></i>
                                {% else %}
                                <a type="submit" 
                                     class="btn sunat" href="{% url 'enviarSunat' id=resultado.0 %}">
                                    <i class="fa-regular fa-envelope fa-2x"></i>
                                </a>
                                {% endif %}
                            </td>           
                         </tr>

                    {% endfor %} 
                      
                </tbody>

            </table>


            
        </div>
    </div>
    
</div>
</div>
</section>

</main><!-- End #main -->

</div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script type="text/javascript">



function confirmarEliminar(idCompra, enlace) {
    let urlEliminar = $(enlace).attr("href");
    Swal.fire({
      title: '¿Seguro que quieres eliminar esta venta?',
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#3085d6',
      cancelButtonColor: '#d33',
      confirmButtonText: 'Sí, eliminar',
      cancelButtonText: 'Cancelar'
    }).then((result) => {
      if (result.isConfirmed) {

        // Redirige a la URL para eliminar la compra si el usuario confirma
        $.ajax({
          type: "GET",
          url: urlEliminar,
          data: {csrfmiddlewaretoken: '{{ csrf_token }}'}, // Incluye el token CSRF en la solicitud
          success: function(response) {
            window.location.href='ventas'
          },

        });

      }
    });
    return false; // Detiene la acción predeterminada del enlace
}

//Para filtrado de ventas
$(function() {
  $('#filtrar').click(function(){
      $.ajax({
          type: "POST",
          url: "{% url 'buscarFechaVentas' %}",
          data: {
              fechaInicio: $('#fechaInicio').val(),
              fechaFin: $('#fechaFin').val(),
              csrfmiddlewaretoken: '{{ csrf_token }}' 
          },
          success: function (response) {
              console.log(response);
              $('tbody').empty(); // Vacía el contenido de la tabla antes de agregar los nuevos resultados
              $.each(response, function(index, resultado) {
                  var row = $('<tr>').addClass('registro');
                  row.append($('<td>').text(index + 1)); // Agrega el número de fila
                  row.append($('<td>').text(resultado[1])); // Accediendo al segundo elemento de la tupla para razonsocial
                  row.append($('<td>').text(resultado[2])); // Accediendo al tercer elemento de la tupla para total
                  row.append($('<td>').text(resultado[3])); // Accediendo al cuarto elemento de la tupla para fechaemision
                  row.append($('<td>').text(resultado[4] + '-' + resultado[5])); // Accediendo al quinto y sexto elemento de la tupla
                  row.append($('<td>').text("A4"));
                  row.append($('<td>').text("Ticket"));
                  

                  // Crea el botón de editar
                  var editButton = $('<a>').addClass('btn');
                  editButton.attr('href', '/ventas/editar/' + resultado[0]);
                  editButton.append($('<i>').addClass('fa-solid fa-pen-to-square fa-2xl').css('color', '#005eff'));
                    
                  // Crea el botón de eliminar
                  var deleteButton = $('<a>').attr('href', '/ventas/eliminarVentas/' + resultado[0]).addClass('eliminar').click(function(){
                      return confirmarEliminar(resultado.idcompra, this);
                  });
                  deleteButton.append($('<i>').addClass('fa-solid fa-trash fa-2xl').css('color', '#f71b02'));
         
                  // Crea la columna de acciones y agrega los botones
                  var actionColumn = $('<td>').append(editButton).append(deleteButton);
                  // Agrega la columna de acciones a la fila
                  row.append(actionColumn);
                  // Agrega la fila a la tabla
                  $('tbody').append(row);

                  // Crea la columna para el botón de envío a sunat
                  var editButtonColumn = $('<td>');
                    var editButton = $('<a>').attr('href', '/ventas/enviarSunat/' + resultado[0]).addClass('btn sunat')
                    editButton.append($('<i>').addClass('fa-regular fa-envelope fa-2x'));
                    editButtonColumn.append(editButton);
                    
                    // Agrega la columna a la fila
                    row.append(editButtonColumn);
                    
              });
          }
      });
  });
});

//Para envíar a sunat
$(document).ready(function() {
    $('.sunat').click(function(event) {
        event.preventDefault();
        Swal.fire({
        title: "¿Seguro de enviar a SUNAT?",
        icon: "question",
        showDenyButton: true,
        confirmButtonText: "Si",
        denyButtonText: `Cancelar`,
        confirmButtonColor: "#3085d6",
        cancelButtonColor: "#d33",
        }).then((result) => {
            /* Read more about isConfirmed, isDenied below */
            if (result.isConfirmed) {
        
                let urlEliminar = $(this).attr("href");
                // Redirige a la URL para eliminar la compra si el usuario confirma
                $.ajax({
                  type: "GET",
                  url: urlEliminar,
                 
                  success: function(response) {
  
                    Swal.fire("¡Enviado!", "", "success").then(()=>{
                    
                      window.location.href='ventas'
                    });
                  },

                });
               
            } 
        });
    });
});
</script>





{% endblock %}

