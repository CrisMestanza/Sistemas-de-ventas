{% extends 'plantilla/base.html' %}
{% block main %}
<main id="main" class="main">
  <div class="pagetitle">
    <h1>TRANSACCIONES</h1>
    <nav>
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="index.html">Home</a></li>
        <li class="breadcrumb-item active">Transacción</li>
      </ol>
    </nav>
  </div><!-- End Page Title -->

  <section class="section dashboard">
    <div class="row">
      <div class="col-lg-12">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">Transacciones</h5>
            <button type="" class="btn btn-success"  data-bs-toggle="modal"
              data-bs-target="#myModaAgregar">Agregar transacción</button>
              
              <table class="table datatable">
                <thead>
                  <tr>
                    <th scope="col">N°</th>
                    <th scope="col">TIPO DE TRANSACCION</th>
                    <th scope="col">EMPLEADO</th>    
                    <th scope="col">MONTO</th>
                    <th scope="col">FECHA</th>
                    <th scope="col">HORA</th>
                    <th scope="col">DESCRIPCION</th>
                    <th scope="col">Acciones</th>
                  </tr>
                </thead>
                <tbody>
                  {% for transaccionRegistro in transacciones_registros_for %}
                  <tr>
                    <td>{{ forloop.counter }}</td>
                    <td>{{ transaccionRegistro.id_tipo_transaccion.nombre }}</td>
                    <td>{{ transaccionRegistro.id_caja.usuario_apertura.nombrecompleto }}</td>
                    <td>{{ transaccionRegistro.monto }}</td>
                    <td>{{ transaccionRegistro.fecha }}</td>
                    <td>{{ transaccionRegistro.hora }}</td>
                    <td>{{ transaccionRegistro.descripcion }}</td>
                    <td>
                      <a type="button" id="btnEditar" class="btn" data-bs-toggle="modal" data-bs-target="#myModal2{{ transaccionRegistro.id_transaccion }}">
                        <i class="fa-solid fa-pen-to-square fa-2xl" style="color: #005eff;"></i>
                      </a>
                      
                    </td>


                     <!-- Modales de editar -->
                      <div class="modal fade" id="myModal2{{ transaccionRegistro.id_transaccion }}" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
                        <div class="modal-dialog" role="document">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h4 class="modal-title">Editar Transacción</h4>
                                    <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                                        <span aria-hidden="true">&times;</span>
                                    </button>
                                </div>
                                <div class="modal-body">
                                    <form id="formEditar{{ transaccionRegistro.id_transaccion }}" action="{% url 'transaccionEditar' %}" method="post" enctype="multipart/form-data">
                                    {% csrf_token %}

                                    <div class="form-group">
                                        <input type="hidden" value="{{ transaccionRegistro.id_transaccion }}" name="id_transaccion">
                                        
                                        <label for="tipoTransaccion1" hidden>TIPO DE TRANSACCIÓN</label><br>
                                        <select class="form-select" name="tipoTransaccion1" hidden>
                                            {% for tipoTransaccion in tipoTransacciones %}
                                                <option value="{{ tipoTransaccion.id_tipo_transaccion }}" {% if transaccionRegistro.id_tipo_transaccion.id_tipo_transaccion == tipoTransaccion.id_tipo_transaccion %}selected{% endif %}>{{ tipoTransaccion.nombre }}</option>
                                            {% endfor %}
                                        </select><br>

                                        <label for="montoTransaccion1">MONTO</label><br>
                                        <input type="text" value="{{ transaccionRegistro.monto }}" name="montoTransaccion1" class="form-control">
                                        <br>
                                        <label for="descripcionTransaccion1">DESCRIPCIÓN</label><br>
                                        <input type="text" value="{{ transaccionRegistro.descripcion }}" name="descripcionTransaccion1" class="form-control">

                                    </div>
                                    <div class="modal-footer">
                                        <button type="submit" class="btn btn-success btn-editar" data-form-id="formEditar{{ transaccionRegistro.id_transaccion }}">Guardar</button>
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                  </div>
                  <!-- fin del modal editar -->
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
              
             
              


            <!-- Modal de Agregar -->
            <div class="modal" id="myModaAgregar">
              <div class="modal-dialog">
                <div class="modal-content">

                  <!-- Cabecera del modal -->
                  <div class="modal-header">
                    <h4 class="modal-title">Agregar transaccion</h4>
                    <button type="button" class="close" data-bs-dismiss="modal">&times;</button>
                  </div>

                  <!-- Contenido del modal De editar-->
                  <div class="modal-body">

                    <!-- inicio de form -->

                    <form id="formAgregar"  action="{% url 'transaccionAgregar' %}" method="post" enctype="multipart/form-data">
                      {% csrf_token %}
                      
                      <input type="hidden" value="{{ usuario.idusuario }}" name="idusuario" >
                      <label for="tipoTransaccion2">TIPO DE TRANSACCION</label><br>
                      <select class="form-select" name="tipoTransaccion2">
                        {% for tipoTransaccion in tipoTransacciones %}
                            <option value="{{ tipoTransaccion.id_tipo_transaccion }}">{{ tipoTransaccion.nombre}}</option>
                        {% endfor %}
                      </select><br>
                    

                      <label for="montoTransaccion2">Monto</label><br>
                      <input type="text" name="montoTransaccion2" class="form-control"> <br>

                      <label for="descripcionTransaccion2">Descripción</label><br>
                      <input type="text" name="descripcionTransaccion2" class="form-control">
                      
                      <div style="display:flex; margin-left:140px;">
                          <div class="modal-footer">
                              <button type="submit" class="btn btn-success" id="btnAgregar">Agregar</button>
                          </div>
                          <div class="modal-footer">
                              <button type="button" id="btn-cerrar" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                          </div>
                      </div>
                    </form>
                  

                  <!-- fin del form -->

                </div>

                <!-- Pie del modal -->

              </div>
            </div>

            <!-- Fin del modal agregar-->

          </div>
        </div>

      </div>
    </div>
  </section>

</main><!-- End #main -->

<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>




<script>
  // Función para obtener el token CSRF de las cookies
  function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
          const cookies = document.cookie.split(';');
          for (let i = 0; i < cookies.length; i++) {
              const cookie = cookies[i].trim();
              if (cookie.substring(0, name.length + 1) === (name + '=')) {
                  cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                  break;
              }
          }
      }
      return cookieValue;
  }
  const csrftoken = getCookie('csrftoken');

  // Agregar usuario
  $('#btnAgregar').click(function() {
      var formData = new FormData($('#formAgregar')[0]);
      $.ajax({
          type: 'POST',
          url: "{% url 'transaccionAgregar' %}",
          data: formData,
          processData: false,
          contentType: false,
          headers: {
              'X-CSRFToken': csrftoken
          },
          success: function(response) {
              Swal.fire({
                  title: 'Transaccion agregada exitosamente',
                  icon: 'success',
                  confirmButtonText: '¡Ok!'
              }).then((result) => {
                  if (result.isConfirmed) {
                      window.location.href = "{% url 'MostrarTransaccion' %}";
                  }
              });
          },
          error: function(response) {
              Swal.fire({
                  title: 'Error al guardar la transacción',
                  text: response.responseText,
                  icon: 'error',
                  confirmButtonText: 'OK'
              });
          }
      });
      return false;
  });

  // Editar usuario
  $('.btn-editar').click(function() {
      var formId = $(this).data('form-id');
      var formData = new FormData($('#' + formId)[0]);
      $.ajax({
          type: 'POST',
          url: "{% url 'transaccionEditar' %}",
          data: formData,
          processData: false,
          contentType: false,
          headers: {
              'X-CSRFToken': csrftoken
          },
          success: function(response) {
              Swal.fire({
                  title: 'Transaccion editada exitosamente',
                  icon: 'success',
                  confirmButtonText: '¡Ok!'
              }).then((result) => {
                  if (result.isConfirmed) {
                      window.location.href = "{% url 'MostrarTransaccion' %}";
                  }
              });
          },
          error: function(response) {
              Swal.fire({
                  title: 'Error al editar la transaccion',
                  text: response.responseText,
                  icon: 'error',
                  confirmButtonText: 'OK'
              });
          }
      });
      return false;
  });

  // Confirmar eliminación de usuario
  function confirmarEliminar(id, enlace) {
      let urlEliminar = $(enlace).attr('href');
      Swal.fire({
          title: '¿Seguro que quieres eliminar este usuario?',
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#3085d6',
          cancelButtonColor: '#d33',
          confirmButtonText: 'Sí, eliminar',
          cancelButtonText: 'Cancelar'
      }).then((result) => {
          if (result.isConfirmed) {
              $.ajax({
                  type: 'GET',
                  url: urlEliminar,
                  headers: {
                      'X-CSRFToken': csrftoken
                  },
                  success: function(response) {
                      window.location.href = "{% url 'usuarios' %}";
                  },
                  error: function(response) {
                      Swal.fire({
                          title: 'Error al eliminar el usuario',
                          text: response.responseText,
                          icon: 'error',
                          confirmButtonText: 'OK'
                      });
                  }
              });
          }
      });
      return false;
  }
</script>






{% endblock %}